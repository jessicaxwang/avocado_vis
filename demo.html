<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <script src="js/d3.v4.min.js"></script>
    <script src="js/topojson.v1.min.js"></script>	
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id='map'></div>
    <div id='lineChart'></div>
    <div id='barChart'></div>
    <script>
        var dummyData = [
            {"month": "jan", "price": [10, 20]},
            {"month": "feb", "price": [20, 14]},
            {"month": "mar", "price": [4, 40]},
            {"month": "apr", "price": [10, 4]},
            {"month": "may", "price": [5, 40]},
            {"month": "jun", "price": [11, 8]},
            {"month": "jul", "price": [12, 3]},
            {"month": "aug", "price": [20, 2]},
            {"month": "sep", "price": [15, 30]},
            {"month": "oct", "price": [50, 40]},
            {"month": "nov", "price": [12, 2]},
            {"month": "dec", "price": [1, 10]}
        ];
        
        var chartDiv = document.getElementById('map')        
        var pageWidth = window.innerWidth;
        var pageHeight = window.innerHeight;
        var divColor = "#bae8c0";
        var backgroundColor = "#556e53"
        var regionMap = d3.map();
    
        d3.select("body").style("background-color", backgroundColor);
    
        // Create Map
        var projection = d3.geoAlbersUsa()
            .translate([pageWidth / 2 , pageHeight / 2])
            .scale([1000]);
    
        var path = d3.geoPath()
                    .projection(projection);
    
        var mapSvg = d3.select('#map').append('svg')
            .attr('width', pageWidth)
            .attr('height', pageHeight)
            .style('background-color', divColor);
    
        d3.json("js/us.json", function(error, us){
            mapSvg.append("path")
                .attr("class", "states")
                .datum(topojson.feature(us, us.objects.states))
                .attr("d", path);
        })
    
        // Create line chart
        var margin = {left: 50, right: 50, top: 50, bottom: 50};
        var width = (pageWidth - margin.left - margin.right); 
        var height = pageHeight - margin.bottom - margin.top;

        var lineChart = d3.select("#lineChart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Shaping the data
        d3.csv('./totalAvocado_v5.csv', function(d){
            return {
                week: d.Date,
                year: d.year,
                avgPrice: +d.AveragePrice,
                region: d.region,
                totalVolume: +d["Total Volume"],
                type: d.type
            };
        }, function(error, rows) {
            process(rows)
        });
    
        /* Populate hashmap to order by region and year
        Key: [region, year]
        Value: [{
            week,
            avgPrice,
            totalVolume
        }]
        */
        function populateRegionMap(data) {
            data.forEach(function(d) {
                if (regionMap.has([d.region, d.year])) {
                    regionMap.get([d.region, d.year]).push({
                        week: d.week,
                        avgPrice: +d.avgPrice,
                        totalVolume: +d.totalVolume
                    });
                } else {
                    regionMap.set([d.region, d.year], [{
                        week: d.week,
                        avgPrice: +d.avgPrice,
                        totalVolume: +d.totalVolume
                    }])
                }
            });
        }
    
        function process(data){
            populateRegionMap(data);    
            // LINE CHART
            // -------------------- Scaling -----------------------//
            var x = d3.scaleTime()
                .rangeRound([0, width]);
            var y = d3.scaleLinear()
                .rangeRound([height, 0]);

            // -------------------- AXES ------------------------//
            var xFormat = "%b";
            var parser = d3.timeParse("%b")
        
            x.domain(d3.extent(dummyData, function(d) { return parser(d.month); }));
            y.domain([0, d3.max(dummyData, function(d) { 
                  return Math.max(d.price[0], d.price[1]);
              })]);

            var line1 = d3.line()
                .x(function(d) { return x(parser(d.month)); }) // set the x values for the line generator
                .y(function(d) { return y(d.price[0]); }) // set the y values for the line generator 
                .curve(d3.curveMonotoneX) // apply smoothing to the line

            var line2 = d3.line()
                .x(function(d) { return x(parser(d.month)); }) // set the x values for the line generator
                .y(function(d) { return y(d.price[1]); }) // set the y values for the line generator 
                .curve(d3.curveMonotoneX) // apply smoothing to the line

            // Append x axis
            lineChart.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).tickFormat(d3.timeFormat(xFormat)));
            
            // Append y axis
            lineChart.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(y));

            // two lines
            var line1  = lineChart.append("path")
                .datum(dummyData) // 10. Binds data to the line 
                .attr("class", "line") // Assign a class for styling 
                .attr("d", line1)  

            var line2 = lineChart.append("path")
                .datum(dummyData) // 10. Binds data to the line 
                .attr("id", "line2")
                .attr("class", "line") // Assign a class for styling 
                .style("stroke", "white")
                .attr("d", line2)  

            lineChart.selectAll(".dot")
                .data(dummyData)
            .enter().append("circle")
                .attr("class", "line")
                .attr("cx", function(d) { 
                    return x(parser(d.month)) })
                .attr("cy", function(d) {
                    return y(d.price[0])})
                .attr("r", 5);
                
            // BAR CHART
        }
    
        
    
    </script>
</body>

</html>    
