<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <script src="js/d3.v4.min.js"></script>
    <script src="js/topojson.v1.min.js"></script>	
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id='map'></div>
    <div id='lineChart'>
        <!-- <div id ='regionDropdown'></div> -->
        <div id ='yearDropdown'></div>
        <div id ='buttonArea'></div>
    </div>
    <div id='barChart'>
        <label><input type="checkbox" id='sort'>Sort values</label>
        <!-- <div id ='sortDropdown'></div> -->
    </div>
    <script>
        const PRICE = 0
        const VOL = 1
        var noneSelected = true;
        var currYear = 2019;
        var currMode = PRICE
        var priceDict = [];
        var regionMenu = d3.select("#regionDropdown")
        var yearMenu = d3.select('#yearDropdown')
        var sortMenu = d3.select('#sort')
        var chartDiv = document.getElementById('map')        
        var pageWidth = window.innerWidth;
        var pageHeight = window.innerHeight;
        var backgroundColor = "white";
        var totalMap = d3.map();
        var totalData = []
    

        regionColors = {}
        var regionNames = ["Albany", "Atlanta", "Baltimore/Washington", "Boise", "Boston", "Buffalo/Rochester", 
        "Charlotte", "Chicago", "Cincinnati/Dayton", "Columbus", "Dallas/Ft. Worth", "Denver", "Detroit", 
        "Grand Rapids", "Harrisburg/Scranton", "Hartford/Springfield", "Houston", "Indianapolis", "Jacksonville", 
        "Las Vegas", "Los Angeles", "Louisville", "Miami/Ft. Lauderdale", "Nashville", "New Orleans/Mobile", 
        "New York", "Orlando", "Philadelphia", "Phoenix/Tucson", "Pittsburgh", "Portland", "Raleigh/Greensboro", 
        "Richmond/Norfolk", "Roanoke", "Sacramento", "San Diego", "San Francisco", "Seattle", "Spokane", "St. Louis",
         "Syracuse", "Tampa"]
        var interval = Math.floor(parseInt('fffffe', 16)/44)
        var current = interval
        for (const [index, element] of regionNames.entries()){

            regionColors[element] = '#'.concat(current.toString(16))
            current = current + interval
        }
        regionColors['Total U.S.'] = "#000000"
        regionColors['Albany'] = '#05d174'
        regionColors['Atlanta'] = '#0ba2e8'

        d3.select("body").style("background-color", backgroundColor);
    
        // Create Map
        var projection = d3.geoAlbersUsa()
            .translate([pageWidth / 4 , pageHeight / 2])
            .scale([((pageWidth/2)/792.5) * 1000]);
    
        var path = d3.geoPath()
                    .projection(projection);
    
        // Create line chart
        var margin = {left: 100, right: 50, top: 50, bottom: 100};
        var lineChartWidth = pageWidth / 2.5 ; 
        var lineChartHeight = pageHeight / 1.3;

        var lineChart = d3.select("#lineChart").append("svg")
            .attr('height', pageHeight)
            .attr('width', pageWidth / 2)
        .append("g")
            .attr("transform", "translate(" + 60 + "," + margin.top + ")");

        var clearAll = d3.select("#buttonArea").append("button")
            .text("Clear All")
            .attr("id", "clearAll")
        
        var xFormat = "%b";
        var parser = d3.timeParse("%b")

// ------------- CREATE AND POPULATE MAP ------------- //
        d3.csv('./regionLatLong.csv', function(d){
            return{
                region: d.region,
                lat: +d.lat,
                long: +d.long
            }
        }, function(error, rows){
            addCityMarkers(rows)
        })

        selectedCities = {}
        function addCityMarkers(data){
            var mapSvg = d3.select('#map').append('svg')
            .attr('width', pageWidth /2)
            .attr('height', pageHeight)
    
            d3.json("js/us.json", function(error, us){
                mapSvg.append("path")
                    .attr("class", "states")
                    .datum(topojson.feature(us, us.objects.states))
                    .attr("d", path);

                data.forEach(function(d){ selectedCities[d.region] = false })

                var imgWidth = 25
                var imgHeight = 25
                mapSvg.selectAll('img')
                    .data(data)
                    .enter()
                    .append('svg:image')
                    .attr("class", "avoIcon")
                    .attr('xlink:href', './avocado.png')
                    .attr('x',function(d){ return projection([d.long, d.lat])[0] - (imgWidth/2)})
                    .attr('y',function(d){ return projection([d.long, d.lat])[1] - (imgHeight/2)})
                    .attr('width', imgWidth)
                    .attr('height', imgHeight)
                    .style('borderStyle', 'solid')
                    .on('mouseover', function(d){ 
                        imgWidth = 50
                        imgHeight = 50
                        d3.select(this)
                          .attr('x',function(d){ return projection([d.long, d.lat])[0] - (imgWidth/2)})
                          .attr('y',function(d){ return projection([d.long, d.lat])[1] - (imgHeight/2)})
                          .attr('width', imgWidth)
                          .attr('height', imgHeight)
                    })
                    .on('mouseout', function (d) { 
                        imgWidth = 25
                        imgHeight = 25
                        d3.select(this)
                          .attr('x',function(d){ return projection([d.long, d.lat])[0] - (imgWidth/2)})
                          .attr('y',function(d){ return projection([d.long, d.lat])[1] - (imgHeight/2)})
                          .attr('width', imgWidth)
                          .attr('height', imgHeight) 
                    })
                    .on('click', function(d) { 
                        if (selectedCities[d.region]){
                            d3.select(this).style('stroke-width', 0)
                              .attr('xlink:href', './avocado.png')
                        } else {
                            d3.select(this).style('stroke-width', 3)
                              .attr('xlink:href', './avocadoBorder.png')
                        }
                        selectedCities[d.region] = !selectedCities[d.region]
                        if (noCitiesSelected()) {
                            noneSelected = true;
                        }
                        updateLineChart(false)
                    })
                
                    // Initialize region menu
                    // regionMenu.append("select")
                    //     .selectAll('option')
                    //         .data(d3.keys(selectedCities).sort())
                    //         .enter()
                    //         .append('option')
                    //     .text(function (d) { 
                    //         return d; 
                    //     })
                    //     .attr("value", function (d) { 
                    //         return d; 
                    //     })
                    
                    // regionMenu.on("change", function(d) {
                    //     var val = d3.select(this)
                    //         .select("select")
                    //         .property("value");
                    //     selectedCities[val] = true;
                    //     updateLineChart(false)
                    // })

                    // Initialize year menu
                    yearMenu.append("select")
                        .attr("class", "years")
                        .selectAll('option')
                            .data([2019, 2018, 2017, 2016])
                            .enter()
                            .append('option')
                        .text(function (d) { 
                            return d; 
                        })
                        .attr("value", function (d) { 
                            return d; 
                        })
                    
                    yearMenu.on("change", function(d) {
                            var val = d3.select(this)
                                .select("select")
                                .property("value");
                                currYear = val;
                            if (noCitiesSelected()) {
                                noneSelected = true;
                            }
                            updateLineChart(false);
                        });

                    priceVol = yearMenu.append("select")
                        .attr("id", "priceVol")
                        .selectAll('option')
                            .data([{"title": "Average Price", "value": 0}, 
                                   {"title": "Average Volume", "value": 1}])
                            .enter()
                            .append('option')
                        .text(function (d) { 
                            return d.title; 
                        })
                        .attr("value", function (d) { 
                            return d.value; 
                    })

                    yearMenu.select("#priceVol").on("change", function (d) {
                        console.log("CHANGED")
                        var newMode = d3.select(this)
                                .property("value");
                        currMode = newMode
                        updateLineChart(false)
                    })
                })
        }

        clearAll.on("click", function() {
            for(var region in selectedCities) { 
                selectedCities[region] = false;
            }
            noneSelected = true;
            d3.select('#map').select("svg").selectAll('.avoIcon')
                .style('stroke-width', 0)
                .attr('xlink:href', './avocado.png')
            updateLineChart(false);
        });

        function noCitiesSelected() {
            for(var region in selectedCities) { 
                if (selectedCities[region])
                    return false;
            }
            return true;
        }   

        // const options = [
        //     {label: "Alphabetical", value: (a, b) => a.name.localeCompare(b.name)},
        //     {label: "Frequency, ascending", value: (a, b) => a.value - b.value},
        //     {label: "Frequency, descending", value: (a, b) => b.value - a.value}
        // ];

        // sortMenu.append("select")
        // .selectAll('option')
        //     .data(options)
        //     .enter()
        //     .append('option')
        // .text(function (d) { 
        //     return d.label; 
        // })
        // .attr("value", function (d) { 
        //     return d.value; 
        // })

// ------------------------------------------- LINE CHART -------------------------------------------- //

        var regionPrices = d3.map()
        d3.csv('./avgAvocado.csv', function(d) {
            avgPrices = [d.janP, d.febP, d.marP, d.aprP, d.mayP, d.junP, d.julP, d.augP, d.sepP, d.octP, d.novP, d.decP]
            avgVol = [d.janV, d.febV, d.marV, d.aprV, d.mayV, d.junV, d.julV, d.augV, d.sepV, d.octV, d.novV, d.decV]
            regionPrices.set([d.region, d.year], [avgPrices, avgVol])
        }, function (error, rows) {
            // Initialize the line chart
            updateLineChart(true);
        });

        var months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"]
        function makePriceDict() {
            priceDict = [{"month": "jan"},
                {"month": "feb"},
                {"month": "mar"},
                {"month": "apr"},
                {"month": "may"},
                {"month": "jun"},
                {"month": "jul"},
                {"month": "aug"},
                {"month": "sep"},
                {"month": "oct"},
                {"month": "nov"},
                {"month": "dec"}]

            if (noneSelected) {
                var pricePerRegion = regionPrices.get(["Total U.S.", currYear])[currMode];
                priceDict.forEach(function (monthObj) {
                        monthObj["Total U.S."] = pricePerRegion[months.indexOf(monthObj.month)];
                })
                noneSelected = false;
            } else {
                d3.keys(selectedCities).forEach(function (d) {
                    if (selectedCities[d]) {
                        var pricePerRegion = regionPrices.get([d, currYear])[currMode];
                        priceDict.forEach(function (monthObj) {
                            monthObj[d] = pricePerRegion[months.indexOf(monthObj.month)];
                        })
                    }
                })
            }
        }

        function lineColor(region){
            return regionColors[region]
        }

        function updateLineChart(init) {
            // Getting new data    
            makePriceDict(currYear);            
            // New title
            lineChart.select("#title").remove();
            if (currMode == PRICE) {
                lineChart.append("text")
                        .attr('x', (lineChartWidth / 2))             
                        .attr('y', 0 - (margin.top / 3))
                        .attr('text-anchor', 'middle') 
                        .attr('id', 'title') 
                        .style('font-size', '16px')
                        .text("ðŸ¥‘Average Monthly Prices (" + currYear + ")ðŸ¥‘")
            } else {
                lineChart.append("text")
                        .attr('x', (lineChartWidth / 2))             
                        .attr('y', 0 - (margin.top / 3))
                        .attr('text-anchor', 'middle') 
                        .attr('id', 'title') 
                        .style('font-size', '16px')
                        .text("ðŸ¥‘Average Monthly Volume of Avocados Sold (" + currYear + ")ðŸ¥‘")
            }
            
            // -------------------- Scaling -----------------------//
            var x = d3.scaleTime()
                .rangeRound([0, lineChartWidth]);
            var y = d3.scaleLinear()
                .rangeRound([lineChartHeight, 0]);

            color = d3.scaleOrdinal(d3.schemeCategory10);
            color.domain(d3.keys(priceDict[0]).filter(function(key) {
                return key !== 'month'
            }));

            var prices = color.domain().map(function(name) {
                return {
                    name: name,
                    values: priceDict.map(function(d) {
                        return {
                            date: d.month,
                            price: +d[name]
                        };
                    })
                };
            });

            // --------------- DOMAINS ------------------ // 
            x.domain(d3.extent(priceDict, function(d) {
                return parser(d.month);
            }));

            y.domain([
                d3.min(prices, function(c) {
                    return d3.min(c.values, function(v) {
                        return v.price;
                    });
                }) - 0.1, 
                d3.max(prices, function(c) {
                    return d3.max(c.values, function(v) {
                        return v.price;
                    });
                })
            ]);

            // Drawing the lines
            line = d3.line()
                .x(function(d) {
                    return x(parser(d.date));
                })
                .y(function(d) {
                    return y(d.price);
                })
                .curve(d3.curveMonotoneX);

            if (!init) {
                d3.selectAll(".price").remove(); // Remove all elements in price
            }
            price = lineChart.selectAll(".price")
                .data(prices)
                .enter().append("g")
                .attr("class", "price");

            // Add lines
            price.append("path")
                .attr("class", "line")
                .attr("d", function(d) {
                    return line(d.values);
                })
                .style("stroke", function(d) {
                    // return color(d.name);
                    return lineColor(d.name)
                });
            
            // Append x axis
            if (init) {
                lineChart.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + lineChartHeight + ")")
                    .call(d3.axisBottom(x).tickFormat(d3.timeFormat(xFormat)));
            }
            // Append y axis
            if (init) {
                lineChart.append("g")
                    .attr("class", "y axis")
                    .call(d3.axisLeft(y))
                    .append("text")
                    .attr("id", "axisText")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .style("fill", "black")
                    .text("Average Price (USD)");
            } else {
                // Redraw Y axis
                lineChart.selectAll(".y.axis")
                    .transition()
                    .duration(750)
                    .call(d3.axisLeft(y))
                lineChart.selectAll("#axisText").remove()
                if (currMode == PRICE) {
                    lineChart.append("text")
                    .attr("id", "axisText")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .style("fill", "black")
                    .text("Average Price (USD)");
                } else {
                    lineChart.append("text")
                    .attr("id", "axisText")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .style("fill", "black")
                    .text("Average Monthly Avocados Sold");
                }
            }

            // Adding dots for price point
            price.append("g").selectAll("circle")
                .data(function(d){ return d.values })
                .enter()
                .append("circle")
                .attr("r", 2)
                .attr("cx", function(dd){ return x(parser(dd.date))})
                .attr("cy", function(dd){ return y(dd.price) })
                .attr('stroke', function(d){ return (lineColor(this.parentNode.__data__.name))} )
                .attr('fill', function(d){ return (lineColor(this.parentNode.__data__.name))} )
                // .attr("fill", "none")
                // .attr("stroke", function(d){return lineColor(this.parentNode.__data__.name)});

            var legend = price.append('circle')
                .attr('class', 'legend')
                .datum(function (d) {
                    return {
                        name: d.name,
                        value: d.values[d.values.length - 1]
                    }
                })
                .attr("cx", lineChartWidth - 100)
                .attr("cy", function(d,i){ return i * 20; })
                .attr("r", 5)
                .style("fill", function(d){ return lineColor(d.name)})

                price.append('text')
                .attr('x', lineChartWidth - 90)
                .attr('y', function(d, i) {
                    return (i * 20);
                })
                .text(function(d) {
                    return d.name;
                })
                .attr("dy", ".35em")
                .attr("font-size", "11px")
                .style("fill", "black");

            // Add mouse line
            lineChart.selectAll(".mouse-over-effects").remove();
            var mouseG = lineChart.append("g")
            .attr("class", "mouse-over-effects");

            mouseG.append("path")
            .attr("class", "mouse-line")
            .style("stroke", "black")
            .style("stroke-width", "1px")
            .style("opacity", "0");

            var lines = document.getElementsByClassName('line');

            var mousePerLine = mouseG.selectAll('.mouse-per-line')
                .data(prices)
                .enter()
                .append("g")
                .attr("class", "mouse-per-line");

                mousePerLine.append("circle")
                .attr("r", 7)
                .style("stroke", function (d) {
                    return lineColor(d.name);
                })
                .style("fill", "none")
                .style("stroke-width", "2px")
                .style("opacity", "0");

                mousePerLine.append("text")
                    .attr("class", "hover-text")
                    .attr("dy", "-1em")
                    .attr("transform", "translate(10,3)");

            // Append a rect to catch mouse movements on canvas
            mouseG.append('svg:rect') 
            .attr('width', lineChartWidth) 
            .attr('height', lineChartHeight)
            .attr('fill', 'none')
            .attr('pointer-events', 'all')
            .on('mouseout', function () { // on mouse out hide line, circles and text
                d3.select(".mouse-line")
                .style("opacity", "0");
                d3.selectAll(".mouse-per-line circle")
                .style("opacity", "0");
                d3.selectAll(".mouse-per-line text")
                .style("opacity", "0");
            })
            .on('mouseover', function () { // on mouse in show line, circles and text
                d3.select(".mouse-line")
                .style("opacity", "1");
                d3.selectAll(".mouse-per-line circle")
                .style("opacity", "1");
                d3.selectAll(".mouse-per-line text")
                .style("opacity", "1");
            })
            .on('mousemove', function () { // mouse moving over canvas
                var mouse = d3.mouse(this);
                d3.selectAll(".mouse-per-line")
                .attr("transform", function (d, i) {
                    var xDate = x.invert(mouse[0]),
                    bisect = d3.bisector(function (d) { return parser(d.date); }).left;
                    idx = bisect(d.values, xDate);

                    d3.select(this).select('text')
                    .text(y.invert(y(d.values[idx].price)).toFixed(2));

                    d3.select(".mouse-line")
                    .attr("d", function () {
                        var data = "M" + x(parser(d.values[idx].date)) + "," + lineChartHeight;
                        data += " " + x(parser(d.values[idx].date)) + "," + 0;
                        return data;
                    });
                    return "translate(" + x(parser(d.values[idx].date)) + "," + y(d.values[idx].price) + ")";
                });
            });
        }
    
    // -------------------------------------------- BAR CHART -------------------------------------------//
    // Create bar chart

    d3.csv('./avgTotals.csv', function(d) {
        totalMap.set([d.region, d.year], d.totalVol)
    }, function (error, rows) {
        updateBarChart();
    });
    
    // Initialize bar chart
    var barChart = d3.select("#barChart").append("svg")
            .attr("width", pageWidth)
            .attr("height", pageHeight)
	        .append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    function createTotalData() {
        totalData = [];
        regionNames.forEach(function (region) {
            totalData.push({
                region: region,
                totalVol: +totalMap.get([region, currYear])
            })
        })
    }

    var barChartWidth = pageWidth - margin.left - margin.right
    var barChartHeight = pageHeight - margin.top - margin.bottom
    function updateBarChart() {
        createTotalData();
        // New title
        barChart.select("#title").remove();
            barChart.append("text")
                    .attr('x', (barChartWidth / 2))             
                    .attr('y', 0 - (margin.top / 3))
                    .attr('text-anchor', 'middle') 
                    .attr('id', 'title') 
                    .style('font-size', '16px')
                    .text("ðŸ¥‘Average Yearly Number of Avocados Sold (" + currYear + ")ðŸ¥‘")

        var xScale = d3.scaleBand().rangeRound([0, barChartWidth]).padding(0.1);
        var yScale = d3.scaleLinear().rangeRound([barChartHeight, 0]);

        xScale.domain(totalData.map(function(d) { return d.region; }));
        yScale.domain([d3.min(totalData, function(d) { return d.totalVol; }) - 1000000, d3.max(totalData, function(d) { return d.totalVol; })]);

        // Add the bars
        barChart.selectAll(".bar")
            .data(totalData)
            .enter()
            .append("rect")
                .attr("class", "bar")
                .attr("fill", "#90983B")
                .attr("x", function(d) { return xScale(d.region); })
                .attr("y", function(d) { return yScale(d.totalVol); })
                .attr("width", xScale.bandwidth())
                .attr("height", function(d) { return barChartHeight - yScale(d.totalVol); })
            .on("mouseover", function(d) {
                d3.select(this).attr("fill", "green")
            }).on("mouseout", function(d) {
                d3.select(this).attr("fill", "#90983B")
            });

        // Append x axis
        barChart.append("g")
            .attr("class", "axis axis--x")
            .attr("transform", "translate(0," + barChartHeight + ")")
            .call(d3.axisBottom(xScale))
            .selectAll("text")
            .attr("y", 0)
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(65)")
            .style("text-anchor", "start")

        // Append y axis
        barChart.append("g")
            .attr("class", "axis axis--y")
            .call(d3.axisLeft(yScale))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Yearly Avocados Sold");
    }

    sortMenu.on("change", function() {
        var xScale = d3.scaleBand().rangeRound([0, barChartWidth]).padding(0.1);
        var xScale0 = xScale.domain(totalData.sort(this.checked
		? function(a, b) { console.log("Sorting"); return b.totalVol - a.totalVol; }
		: function(a, b) { console.log("Alphabetizing"); return d3.ascending(a.region, b.region); })
		.map(function(d) { return d.region; }))
		.copy();

        barChart.selectAll(".bar")
            .sort(function(a, b) { return xScale0(a.region) - xScale0(b.region); });

        var transition = barChart.transition().duration(750);
        var delay = function(d, i) { return i * 50; };

        transition.selectAll(".bar")
                .delay(delay)
                .attr("x", function(d) { return xScale0(d.region); });

        transition.select(".axis--x")
            .call(d3.axisBottom(xScale))
            .selectAll("g")
                .delay(delay)
            .selectAll('text')
            .attr("y", 0)
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(65)")
            .style("text-anchor", "start")
    });

    </script>
</body>

</html>    
