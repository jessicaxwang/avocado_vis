<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <script src="js/d3.v4.min.js"></script>
    <script src="js/topojson.v1.min.js"></script>	
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id='map'></div>
    <div id='lineChart'>
        <div id ='regionDropdown'></div>
    </div>
    <div id='barChart'></div>
    <script>
        var chartDiv = document.getElementById('map')        
        var pageWidth = window.innerWidth;
        var pageHeight = window.innerHeight;
        var divColor = "#bae8c0";
        var backgroundColor = "#556e53"
        var regionMap = d3.map();
    
        d3.select("body").style("background-color", backgroundColor);
    
        // Create Map
        var projection = d3.geoAlbersUsa()
            .translate([pageWidth / 2 , pageHeight / 2])
            .scale([1000]);
    
        var path = d3.geoPath()
                    .projection(projection);
    

        // Create line chart
        var margin = {left: 50, right: 50, top: 50, bottom: 50};
        var lineChartWidth = pageWidth / 2.5 ; 
        var lineChartHeight = pageHeight / 1.3;

        var lineChart = d3.select("#lineChart").append("svg")
            .attr("width", lineChartWidth + margin.left + margin.right)
            .attr("height", lineChartHeight + margin.top + margin.bottom)
        .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        var xFormat = "%b";
        var parser = d3.timeParse("%b")


// ------------- CREATE AND POPULATE MAP ------------- //
        d3.csv('./regionLatLong.csv', function(d){
            return{
                region: d.region,
                lat: +d.lat,
                long: +d.long
            }
        }, function(error, rows){
            addCityMarkers(rows)
        })

        selectedCities = {}
        function addCityMarkers(data){
            var mapSvg = d3.select('#map').append('svg')
            .attr('width', pageWidth)
            .attr('height', pageHeight)
            .style('background-color', divColor);
    
            d3.json("js/us.json", function(error, us){
                mapSvg.append("path")
                    .attr("class", "states")
                    .datum(topojson.feature(us, us.objects.states))
                    .attr("d", path);

                data.forEach(function(d){ selectedCities[d.region] = false })
                mapSvg.selectAll('circle')
                    .data(data)
                    .enter()
                    .append('circle')
                    // .attr('xlink:href', './avocado.png')
                    .attr('cx',function(d){ return projection([d.long, d.lat])[0] })
                    .attr('cy',function(d){ return projection([d.long, d.lat])[1] })
                    // .attr('width', 20)
                    // .attr('height', 20)
                    .attr('r', 8)
                    .style('stroke', 'yellow')
                    .style('stroke-width', 0)
                    // .on('mouseover', function(d){ d3.select(this).attr('height', 100)})
                    // .on('mouseout', function (d) { d3.select(this).attr('height', 20)})
                    .on('mouseover', function(d){ d3.select(this).attr('r', 12)})
                    .on('mouseout', function (d) { d3.select(this).attr('r', 8)})
                    .on('click', function(d) { 
                        updateLineChart(d.region);
                        if (selectedCities[d.region]){
                            d3.select(this).style('stroke-width', 0)
                        } else {
                            d3.select(this).style('stroke-width', 3)
                        }
                        selectedCities[d.region] = !selectedCities[d.region]
                    })
            })
        }
                    
// ------------------------------------------------------ //

        var regionPrices = d3.map()
        d3.csv('./avgAvocado.csv', function(d) {
            avgPrices = [d.jan, d.feb, d.mar, d.apr, d.may, d.jun, d.jul, d.aug, d.sep, d.oct, d.nov, d.dec]
            regionPrices.set([d.region, d.year], avgPrices)
        }, function (error, rows) {
            // Add dropdown menu
            var regionMenu = d3.select("#regionDropdown")
                    .append("select")
                    .selectAll("option")
                    .data(regionPrices)
                    .enter()
                    .append("option")
                    .attr("value", function(d){
                        console.log(d)
                        return d.date
                    })
                    .text(function(d){
                        console.log(d)
                        return d.key[0];
                    })

            initLineChart("Albany");
            

            // Button handling here

        });
        function makePriceDict(region) {
            y2016 = regionPrices.get([region, '2016'])
            y2017 = regionPrices.get([region, '2017'])
            y2018 = regionPrices.get([region, '2018'])
            y2019 = regionPrices.get([region, '2019'])
            return priceDict = [
                {"month": "jan", "2016": y2016[0], "2017": y2017[0], "2018": y2018[0], "2019": y2019[0]},
                {"month": "feb", "2016": y2016[1], "2017": y2017[1], "2018": y2018[1], "2019": y2019[1]},
                {"month": "mar", "2016": y2016[2], "2017": y2017[2], "2018": y2018[2], "2019": y2019[2]},
                {"month": "apr", "2016": y2016[3], "2017": y2017[3], "2018": y2018[3], "2019": y2019[3]},
                {"month": "may", "2016": y2016[4], "2017": y2017[4], "2018": y2018[4], "2019": y2019[4]},
                {"month": "jun", "2016": y2016[5], "2017": y2017[5], "2018": y2018[5], "2019": y2019[5]},
                {"month": "jul", "2016": y2016[6], "2017": y2017[6], "2018": y2018[6], "2019": y2019[6]},
                {"month": "aug", "2016": y2016[7], "2017": y2017[7], "2018": y2018[7], "2019": y2019[7]},
                {"month": "sep", "2016": y2016[8], "2017": y2017[8], "2018": y2018[8], "2019": y2019[8]},
                {"month": "oct", "2016": y2016[9], "2017": y2017[9], "2018": y2018[9], "2019": y2019[9]},
                {"month": "nov", "2016": y2016[10], "2017": y2017[10], "2018": y2018[10], "2019": y2019[10]},
                {"month": "dec", "2016": y2016[11], "2017": y2017[11], "2018": y2018[11], "2019": y2019[11]}
            ]
        }

        function initLineChart(region) {
            var priceDict = makePriceDict(region);

            // New title
            lineChart.append('text')
                .attr('x', (lineChartWidth / 2))             
                .attr('y', 0 - (margin.top / 3))
                .attr('text-anchor', 'middle') 
                .attr('id', 'title') 
                .style('font-size', '16px')
                .text(region)

            // -------------------- Scaling -----------------------//
            x = d3.scaleTime()
                .rangeRound([0, lineChartWidth]);
            y = d3.scaleLinear()
                .rangeRound([lineChartHeight, 0]);

            color = d3.scaleOrdinal(d3.schemeTableau10);
            color.domain(d3.keys(priceDict[0]).filter(function(key) {
                return key !== 'month'
            }));

            var prices = color.domain().map(function(name) {
                return {
                    name: name,
                    values: priceDict.map(function(d) {
                        return {
                            date: d.month,
                            price: +d[name]
                        };
                    })
                };
            });

            // --------------- DOMAINS ------------------ // 
            x.domain(d3.extent(priceDict, function(d) {
                return parser(d.month);
            }));

            y.domain([
                d3.min(prices, function(c) {
                    return d3.min(c.values, function(v) {
                        return v.price;
                    });
                }) - 0.1, 
                d3.max(prices, function(c) {
                    return d3.max(c.values, function(v) {
                        return v.price;
                    });
                })
            ]);

            // Drawing the lines
            line = d3.line()
                .x(function(d) {
                    return x(parser(d.date));
                })
                .y(function(d) {
                    return y(d.price);
                })
                .curve(d3.curveMonotoneX);
                
            var price = lineChart.selectAll(".price")
                .data(prices)
                .enter().append("g")
                .attr("class", "price");

            price.append("path")
                .attr("class", "line")
                .attr("d", function(d) {
                    return line(d.values);
                })
                .style("stroke", function(d) {
                    return color(d.name);
                });

            // Append x axis
            lineChart.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + lineChartHeight + ")")
                .call(d3.axisBottom(x).tickFormat(d3.timeFormat(xFormat)));
            
            // Append y axis
            lineChart.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(y));

            // Adding dots for price point
            // price.append("g").selectAll("circle")
            //     .data(function(d){ return d.values })
            //     .enter()
            //     .append("circle")
            //     .attr("r", 2)
            //     .attr("cx", function(dd){ return x(parser(dd.date))})
            //     .attr("cy", function(dd){ return y(dd.price) })
            //     .attr("fill", "none")
            //     .attr("stroke", function(d){return color(this.parentNode.__data__.name)});

            // Adding label to end of each line
            price.append("text")
                .attr("class", "label")
                .datum(function (d) {
                    return {
                        name: d.name,
                        value: d.values[d.values.length - 1]
                    };
                })
                .attr("transform", function (d) {
                    return "translate(" + x(parser(d.value.date)) + "," + y(d.value.price) + ")";
                })
                .attr("x", 3)
                .attr("dy", ".35em")
                .attr("font-size", "15px")
                .text(function (d) {
                    return d.name;
            });

            // Add mouse line
            var mouseG = lineChart.append("g")
            .attr("class", "mouse-over-effects");

            mouseG.append("path")
            .attr("class", "mouse-line")
            .style("stroke", "black")
            .style("stroke-width", "1px")
            .style("opacity", "0");

            var lines = document.getElementsByClassName('line');

            var mousePerLine = mouseG.selectAll('.mouse-per-line')
                .data(prices)
                .enter()
                .append("g")
                .attr("class", "mouse-per-line");

                mousePerLine.append("circle")
                .attr("r", 7)
                .style("stroke", function (d) {
                    return color(d.name);
                })
                .style("fill", "none")
                .style("stroke-width", "2px")
                .style("opacity", "0");

                mousePerLine.append("text")
                    .attr("class", "hover-text")
                    .attr("dy", "-1em")
                    .attr("transform", "translate(10,3)");

            // Append a rect to catch mouse movements on canvas
            mouseG.append('svg:rect') 
            .attr('width', lineChartWidth) 
            .attr('height', lineChartHeight)
            .attr('fill', 'none')
            .attr('pointer-events', 'all')
            .on('mouseout', function () { // on mouse out hide line, circles and text
                d3.select(".mouse-line")
                .style("opacity", "0");
                d3.selectAll(".mouse-per-line circle")
                .style("opacity", "0");
                d3.selectAll(".mouse-per-line text")
                .style("opacity", "0");
            })
            .on('mouseover', function () { // on mouse in show line, circles and text
                d3.select(".mouse-line")
                .style("opacity", "1");
                d3.selectAll(".mouse-per-line circle")
                .style("opacity", "1");
                d3.selectAll(".mouse-per-line text")
                .style("opacity", "1");
            })
            .on('mousemove', function () { // mouse moving over canvas
                var mouse = d3.mouse(this);
                d3.selectAll(".mouse-per-line")
                .attr("transform", function (d, i) {
                    var xDate = x.invert(mouse[0]),
                    bisect = d3.bisector(function (d) { return parser(d.date); }).left;
                    idx = bisect(d.values, xDate);

                    d3.select(this).select('text')
                    .text("$" + (y.invert(y(d.values[idx].price)).toFixed(2)));

                    d3.select(".mouse-line")
                    .attr("d", function () {
                        var data = "M" + x(parser(d.values[idx].date)) + "," + lineChartHeight;
                        data += " " + x(parser(d.values[idx].date)) + "," + 0;
                        return data;
                    });
                    return "translate(" + x(parser(d.values[idx].date)) + "," + y(d.values[idx].price) + ")";
                });
            });
        }
        function updateLineChart(region) {
            // New title
            lineChart.select('#title')
                .attr('x', (lineChartWidth / 2))             
                .attr('y', 0 - (margin.top / 3))
                .attr('text-anchor', 'middle')  
                .style('font-size', '16px')
                .text(region)

            var priceDict = makePriceDict(region)
            // New prices map
            var prices = color.domain().map(function(name) {
                return {
                    name: name,
                    values: priceDict.map(function(d) {
                        return {
                            date: d.month,
                            price: +d[name]
                        };
                    })
                };
            });

            console.log(prices)

            // Update y domain
            y.domain([
                d3.min(prices, function(c) {
                    return d3.min(c.values, function(v) {
                        return v.price;
                    });
                }) - 0.1,
                d3.max(prices, function(c) {
                    return d3.max(c.values, function(v) {
                        return v.price;
                    });
                })
            ]);

            // Clear and redraw price lines
            var price = lineChart.selectAll(".price")
            price.selectAll("g > *").remove(); // Remove all g elements in price

            price.data(prices)
                .enter().append("g")
                .attr("class", "price");

            price.append("path")
                .attr("class", "line")
                .attr("d", function(d) {
                    return line(d.values);
                })
                .style("stroke", function(d) {
                    return color(d.name);
                });
            

            // Update y axis
            lineChart.selectAll(".y.axis")
                .transition()
                .duration(750)
                .call(d3.axisLeft(y));
            
        }

    </script>
</body>

</html>    
